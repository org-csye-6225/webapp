name: Build Custom Image

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout webapp
      uses: actions/checkout@v2

    - name: Create webapp zip artifact
      run: zip -r /tmp/webapp.zip .

    - name: Upload repository artifact
      uses: actions/upload-artifact@v2
      with:
        name: webapp-artifact
        path: /tmp/webapp.zip

    - name: Download webapp artifact
      uses: actions/download-artifact@v2
      with:
        name: webapp-artifact
    
    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
          version: '>= 363.0.0'
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_email: ${{ secrets.GCP_SA_EMAIL }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          
    - name: 'Use gcloud CLI'
      run: 'gcloud info'

    - name: Create variables.pkr.hcl
      run: |
        echo 'variable "MYSQL_ROOT_PASSWORD" {}' > variables.pkr.hcl
        echo 'variable "SQL_USER" {}' >> variables.pkr.hcl
        echo 'variable "SQL_PSWD" {}' >> variables.pkr.hcl
        echo 'variable "AUTH_USER" {}' >> variables.pkr.hcl
        echo 'variable "AUTH_PSWD" {}' >> variables.pkr.hcl

    - name: Set Variables from Secrets
      run: |
        echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> variables.pkr.hcl
        echo "SQL_USER=${{ secrets.SQL_USER }}" >> variables.pkr.hcl
        echo "SQL_PSWD=${{ secrets.SQL_PSWD }}" >> variables.pkr.hcl
        echo "AUTH_USER=${{ secrets.AUTH_USER }}" >> variables.pkr.hcl
        echo "AUTH_PSWD=${{ secrets.AUTH_PSWD }}" >> variables.pkr.hcl

    - name: Display variables.pkr.hcl
      run: cat variables.pkr.hcl

    - name: Initialize Packer
      run:  packer init packer/packer_file.pkr.hcl

    - name: Format Packer configuration
      run:  packer fmt packer/packer_file.pkr.hcl

    - name: Validate Packer configuration
      run:  packer validate packer/packer_file.pkr.hcl

    - name: Run Packer Build
      run: packer build -var-file=variables.pkr.hcl packer/packer_file.pkr.hcl